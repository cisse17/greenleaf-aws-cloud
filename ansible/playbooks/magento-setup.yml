---
# ============================================================================
# GREENLEAF - PLAYBOOK D'INSTALLATION MAGENTO
# ============================================================================

- name: GreenLeaf - Installation et configuration Magento
  hosts: magento
  become: yes
  gather_facts: yes
  
  tasks:
    # ========================================================================
    # ÉTAPE 1 : PRÉPARATION DU SYSTÈME
    # ========================================================================
    
    - name: 1.1 - Afficher les informations système
      debug:
        msg: 
          - "=========================================="
          - "Installation GreenLeaf Magento"
          - "=========================================="
          - "OS : {{ ansible_distribution }} {{ ansible_distribution_version }}"
          - "CPU : {{ ansible_processor_vcpus }} vCPUs"
          - "RAM : {{ ansible_memtotal_mb }} MB"
          - "Hostname : {{ ansible_hostname }}"
          - "=========================================="
      tags: system
    
    - name: 1.2 - Mise à jour du cache APT
      apt:
        update_cache: yes
        cache_valid_time: 3600
      tags: system
    
    - name: 1.3 - Installation des outils de base
      apt:
        name:
          - curl
          - wget
          - git
          - unzip
          - vim
          - software-properties-common
          - apt-transport-https
          - ca-certificates
          - gnupg
          - lsb-release
        state: present
        update_cache: yes
      tags: system
    
    - name: 1.4 - Configurer le timezone
      timezone:
        name: "{{ server_timezone }}"
      tags: system
    
    - name: 1.5 - Configurer la locale
      locale_gen:
        name: "{{ server_locale }}"
        state: present
      tags: system
    
    - name: 1.6 - Message de succès ÉTAPE 1
      debug:
        msg:
          - "=========================================="
          - "ÉTAPE 1 COMPLÉTÉE AVEC SUCCÈS !"
          - "=========================================="
          - "Système préparé et prêt pour Nginx"
          - "Timezone : {{ server_timezone }}"
          - "Locale : {{ server_locale }}"
          - "=========================================="
      tags: system
    # ========================================================================
    # ÉTAPE 2 : INSTALLATION ET CONFIGURATION NGINX
    # ========================================================================
    
    - name: 2.1 - Installer Nginx
      apt:
        name: nginx
        state: present
        update_cache: yes
      tags: nginx
    
    - name: 2.2 - Créer le répertoire Magento
      file:
        path: "{{ magento_root }}"
        state: directory
        owner: "{{ nginx_user }}"
        group: "{{ nginx_user }}"
        mode: '0755'
      tags: nginx
    
    - name: 2.3 - Créer le répertoire pour les sites disponibles
      file:
        path: /var/www/html
        state: directory
        owner: "{{ nginx_user }}"
        group: "{{ nginx_user }}"
        mode: '0755'
      tags: nginx
    
    - name: 2.4 - Créer une page de test temporaire
      copy:
        content: |
          <!DOCTYPE html>
          <html>
          <head>
              <title>GreenLeaf - En cours d'installation</title>
              <style>
                  body { font-family: Arial; text-align: center; padding: 50px; background: #f0f0f0; }
                  h1 { color: #2ecc71; }
              </style>
          </head>
          <body>
              <h1>GreenLeaf E-commerce</h1>
              <h2>Installation Magento en cours...</h2>
              <p>Nginx est opérationnel</p>
          </body>
          </html>
        dest: /var/www/html/index.html
        owner: "{{ nginx_user }}"
        group: "{{ nginx_user }}"
        mode: '0644'
      tags: nginx
    
    - name: 2.5 - Supprimer la configuration Nginx par défaut
      file:
        path: /etc/nginx/sites-enabled/default
        state: absent
      tags: nginx
    
    - name: 2.6 - Créer la configuration Nginx pour Magento
      copy:
        content: |
          upstream fastcgi_backend {
              server unix:/run/php/php{{ php_version }}-fpm.sock;
          }

          server {
              listen 80;
              server_name localhost {{ ansible_hostname }};
              
              set $MAGE_ROOT {{ magento_root }};
              set $MAGE_MODE developer;
              
              root $MAGE_ROOT/pub;
              
              index index.php;
              autoindex off;
              charset UTF-8;
              
              client_max_body_size 64M;
              
              # Logs
              access_log /var/log/nginx/magento_access.log;
              error_log /var/log/nginx/magento_error.log;
              
              # Page de test temporaire (avant installation Magento)
              location = / {
                  try_files /index.html /index.php$is_args$args;
              }
              
              location / {
                  try_files $uri $uri/ /index.php$is_args$args;
              }
              
              location /pub/ {
                  location ~ ^/pub/media/(downloadable|customer|import|theme_customization/.*\.xml) {
                      deny all;
                  }
                  alias $MAGE_ROOT/pub/;
                  add_header X-Frame-Options "SAMEORIGIN";
              }
              
              location /static/ {
                  expires max;
                  location ~ ^/static/version {
                      rewrite ^/static/(version\d*/)?(.*)$ /static/$2 last;
                  }
                  location ~* \.(ico|jpg|jpeg|png|gif|svg|js|css|swf|eot|ttf|otf|woff|woff2|json)$ {
                      add_header Cache-Control "public";
                      add_header X-Frame-Options "SAMEORIGIN";
                      expires +1y;
                      if (!-f $request_filename) {
                          rewrite ^/static/?(.*)$ /static.php?resource=$1 last;
                      }
                  }
                  location ~* \.(zip|gz|gzip|bz2|csv|xml)$ {
                      add_header Cache-Control "no-store";
                      add_header X-Frame-Options "SAMEORIGIN";
                      expires off;
                      if (!-f $request_filename) {
                          rewrite ^/static/?(.*)$ /static.php?resource=$1 last;
                      }
                  }
                  if (!-f $request_filename) {
                      rewrite ^/static/?(.*)$ /static.php?resource=$1 last;
                  }
                  add_header X-Frame-Options "SAMEORIGIN";
              }
              
              location /media/ {
                  try_files $uri $uri/ /get.php$is_args$args;
                  location ~ ^/media/theme_customization/.*\.xml {
                      deny all;
                  }
                  location ~* \.(ico|jpg|jpeg|png|gif|svg|js|css|swf|eot|ttf|otf|woff|woff2)$ {
                      add_header Cache-Control "public";
                      add_header X-Frame-Options "SAMEORIGIN";
                      expires +1y;
                      try_files $uri $uri/ /get.php$is_args$args;
                  }
                  location ~* \.(zip|gz|gzip|bz2|csv|xml)$ {
                      add_header Cache-Control "no-store";
                      add_header X-Frame-Options "SAMEORIGIN";
                      expires off;
                      try_files $uri $uri/ /get.php$is_args$args;
                  }
                  add_header X-Frame-Options "SAMEORIGIN";
              }
              
              location /media/customer/ {
                  deny all;
              }
              
              location /media/downloadable/ {
                  deny all;
              }
              
              location /media/import/ {
                  deny all;
              }
              
              # PHP entry point for main application
              location ~ ^/(index|get|static|errors/report|errors/404|errors/503|health_check)\.php$ {
                  try_files $uri =404;
                  fastcgi_pass fastcgi_backend;
                  fastcgi_buffers 1024 4k;
                  fastcgi_buffer_size 128k;
                  fastcgi_busy_buffers_size 256k;
                  fastcgi_read_timeout 600s;
                  fastcgi_connect_timeout 600s;
                  
                  fastcgi_index index.php;
                  fastcgi_param PHP_FLAG "session.auto_start=off \n suhosin.session.cryptua=off";
                  fastcgi_param PHP_VALUE "memory_limit={{ php_memory_limit }} \n max_execution_time={{ php_max_execution_time }}";
                  fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
                  fastcgi_param MAGE_MODE $MAGE_MODE;
                  
                  include fastcgi_params;
              }
              
              # Deny everything else in .php
              location ~* \.php$ {
                  deny all;
              }
              
              # Deny access to sensitive files
              location ~* (\.git|\.htaccess|\.htpasswd|\.sample|composer\.json|composer\.lock|\.DS_Store) {
                  deny all;
              }
          }
        dest: /etc/nginx/sites-available/magento
        owner: root
        group: root
        mode: '0644'
      tags: nginx
    
    - name: 2.7 - Activer le site Magento
      file:
        src: /etc/nginx/sites-available/magento
        dest: /etc/nginx/sites-enabled/magento
        state: link
      tags: nginx
    
    - name: 2.8 - Tester la configuration Nginx
      command: nginx -t
      register: nginx_test
      changed_when: false
      tags: nginx
    
    - name: 2.9 - Afficher le résultat du test Nginx
      debug:
        var: nginx_test.stderr_lines
      tags: nginx
    
    - name: 2.10 - Démarrer et activer Nginx
      systemd:
        name: nginx
        state: started
        enabled: yes
        daemon_reload: yes
      tags: nginx
    
    - name: 2.11 - Redémarrer Nginx
      systemd:
        name: nginx
        state: restarted
      tags: nginx
    
    - name: 2.12 - Vérifier que Nginx est actif
      systemd:
        name: nginx
        state: started
      register: nginx_status
      tags: nginx
    
    - name: 2.13 - Message de succès ÉTAPE 2
      debug:
        msg:
          - "=========================================="
          - "ÉTAPE 2 COMPLÉTÉE AVEC SUCCÈS !"
          - "=========================================="
          - "Nginx installé et configuré pour Magento"
          - "Configuration : /etc/nginx/sites-available/magento"
          - "Test : curl http://localhost"
          - "=========================================="
      tags: nginx
    # ========================================================================
    # ÉTAPE 3 : INSTALLATION PHP 8.2 ET EXTENSIONS MAGENTO
    # ========================================================================
    
    - name: 3.1 - Installer PHP {{ php_version }} et extensions Magento
      apt:
        name:
          - php{{ php_version }}-fpm
          - php{{ php_version }}-cli
          - php{{ php_version }}-common
          - php{{ php_version }}-mysql
          - php{{ php_version }}-curl
          - php{{ php_version }}-gd
          - php{{ php_version }}-intl
          - php{{ php_version }}-mbstring
          - php{{ php_version }}-soap
          - php{{ php_version }}-xml
          - php{{ php_version }}-zip
          - php{{ php_version }}-bcmath
          - php{{ php_version }}-opcache
          - php{{ php_version }}-redis
          - php{{ php_version }}-xsl
        state: present
        update_cache: yes
      tags: php
    
    - name: 3.2 - Vérifier la version de PHP
      command: php -v
      register: php_version_output
      changed_when: false
      tags: php
    
    - name: 3.3 - Afficher la version de PHP
      debug:
        msg: "{{ php_version_output.stdout_lines }}"
      tags: php
    
    - name: 3.4 - Configurer PHP pour Magento (php.ini CLI)
      lineinfile:
        path: /etc/php/{{ php_version }}/cli/php.ini
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        backup: yes
      loop:
        - { regexp: '^memory_limit', line: 'memory_limit = {{ php_memory_limit }}' }
        - { regexp: '^max_execution_time', line: 'max_execution_time = {{ php_max_execution_time }}' }
        - { regexp: '^max_input_time', line: 'max_input_time = 1800' }
        - { regexp: '^upload_max_filesize', line: 'upload_max_filesize = 64M' }
        - { regexp: '^post_max_size', line: 'post_max_size = 64M' }
        - { regexp: '^;date.timezone', line: 'date.timezone = Europe/Paris' }
        - { regexp: '^date.timezone', line: 'date.timezone = Europe/Paris' }
      tags: php
    
    - name: 3.5 - Configurer PHP pour Magento (php.ini FPM)
      lineinfile:
        path: /etc/php/{{ php_version }}/fpm/php.ini
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        backup: yes
      loop:
        - { regexp: '^memory_limit', line: 'memory_limit = {{ php_memory_limit }}' }
        - { regexp: '^max_execution_time', line: 'max_execution_time = {{ php_max_execution_time }}' }
        - { regexp: '^max_input_time', line: 'max_input_time = 1800' }
        - { regexp: '^upload_max_filesize', line: 'upload_max_filesize = 64M' }
        - { regexp: '^post_max_size', line: 'post_max_size = 64M' }
        - { regexp: '^;date.timezone', line: 'date.timezone = Europe/Paris' }
        - { regexp: '^date.timezone', line: 'date.timezone = Europe/Paris' }
        - { regexp: '^;opcache.enable=', line: 'opcache.enable=1' }
        - { regexp: '^opcache.enable=', line: 'opcache.enable=1' }
        - { regexp: '^;opcache.memory_consumption', line: 'opcache.memory_consumption=512' }
        - { regexp: '^opcache.memory_consumption', line: 'opcache.memory_consumption=512' }
        - { regexp: '^;opcache.max_accelerated_files', line: 'opcache.max_accelerated_files=60000' }
        - { regexp: '^opcache.max_accelerated_files', line: 'opcache.max_accelerated_files=60000' }
        - { regexp: '^;opcache.save_comments', line: 'opcache.save_comments=1' }
        - { regexp: '^opcache.save_comments', line: 'opcache.save_comments=1' }
      tags: php
    
    - name: 3.6 - Configurer le pool PHP-FPM
      lineinfile:
        path: /etc/php/{{ php_version }}/fpm/pool.d/www.conf
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        backup: yes
      loop:
        - { regexp: '^user = ', line: 'user = {{ nginx_user }}' }
        - { regexp: '^group = ', line: 'group = {{ nginx_user }}' }
        - { regexp: '^listen.owner', line: 'listen.owner = {{ nginx_user }}' }
        - { regexp: '^listen.group', line: 'listen.group = {{ nginx_user }}' }
        - { regexp: '^;listen.mode', line: 'listen.mode = 0660' }
        - { regexp: '^listen.mode', line: 'listen.mode = 0660' }
        - { regexp: '^pm.max_children', line: 'pm.max_children = 50' }
        - { regexp: '^pm.start_servers', line: 'pm.start_servers = 5' }
        - { regexp: '^pm.min_spare_servers', line: 'pm.min_spare_servers = 5' }
        - { regexp: '^pm.max_spare_servers', line: 'pm.max_spare_servers = 35' }
      tags: php
    
    - name: 3.7 - Redémarrer PHP-FPM
      systemd:
        name: php{{ php_version }}-fpm
        state: restarted
        enabled: yes
        daemon_reload: yes
      tags: php
    
    - name: 3.8 - Vérifier que PHP-FPM est actif
      systemd:
        name: php{{ php_version }}-fpm
        state: started
      register: php_fpm_status
      tags: php
    
    - name: 3.9 - Créer un fichier de test PHP
      copy:
        content: |
          <?php
          phpinfo();
        dest: /var/www/magento/pub/info.php
        owner: "{{ nginx_user }}"
        group: "{{ nginx_user }}"
        mode: '0644'
      tags: php
    
    - name: 3.10 - Redémarrer Nginx
      systemd:
        name: nginx
        state: restarted
      tags: php
    
    - name: 3.11 - Message de succès ÉTAPE 3
      debug:
        msg:
          - "=========================================="
          - " ÉTAPE 3 COMPLÉTÉE AVEC SUCCÈS !"
          - "=========================================="
          - "PHP {{ php_version }} installé avec toutes les extensions Magento"
          - "PHP-FPM configuré et actif"
          - "Test : curl http://localhost/info.php"
          - "N'oubliez pas de supprimer info.php en production !"
          - "=========================================="
      tags: php
    # ========================================================================
    # ÉTAPE 4 : INSTALLATION ET CONFIGURATION MYSQL
    # ========================================================================
    
    - name: 4.1 - Installer MySQL Server et client
      apt:
        name:
          - mysql-server
          - mysql-client
          - python3-pymysql
        state: present
        update_cache: yes
      tags: mysql
    
    - name: 4.2 - Démarrer et activer MySQL
      systemd:
        name: mysql
        state: started
        enabled: yes
      tags: mysql
    
    - name: 4.3 - Vérifier que MySQL est actif
      systemd:
        name: mysql
        state: started
      register: mysql_status
      tags: mysql
    
    - name: 4.4 - Créer la base de données Magento
      mysql_db:
        name: "{{ db_name }}"
        state: present
        login_unix_socket: /var/run/mysqld/mysqld.sock
      tags: mysql
      when: false
    
    - name: 4.5 - Créer l'utilisateur Magento
      mysql_user:
        name: "{{ db_username }}"
        password: "{{ db_password }}"
        priv: "{{ db_name }}.*:ALL"
        host: "{{ db_host }}"
        state: present
        login_unix_socket: /var/run/mysqld/mysqld.sock
      tags: mysql
      when: false
    
    - name: 4.6 - Configurer MySQL pour Magento
      lineinfile:
        path: /etc/mysql/mysql.conf.d/mysqld.cnf
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        insertafter: "^\\[mysqld\\]"
        backup: yes
      loop:
        - { regexp: '^max_allowed_packet', line: 'max_allowed_packet = 64M' }
        - { regexp: '^innodb_buffer_pool_size', line: 'innodb_buffer_pool_size = 1G' }
        - { regexp: '^innodb_log_file_size', line: 'innodb_log_file_size = 256M' }
        - { regexp: '^innodb_flush_log_at_trx_commit', line: 'innodb_flush_log_at_trx_commit = 2' }
        - { regexp: '^innodb_flush_method', line: 'innodb_flush_method = O_DIRECT' }
        - { regexp: '^table_open_cache', line: 'table_open_cache = 4000' }
        - { regexp: '^join_buffer_size', line: 'join_buffer_size = 8M' }
        - { regexp: '^sort_buffer_size', line: 'sort_buffer_size = 8M' }
        - { regexp: '^read_rnd_buffer_size', line: 'read_rnd_buffer_size = 8M' }
      tags: mysql
    
    - name: 4.7 - Redémarrer MySQL pour appliquer les changements
      systemd:
        name: mysql
        state: restarted
      tags: mysql
    
    - name: 4.8 - Tester la connexion MySQL
      command: mysql -u{{ db_username }} -p{{ db_password }} -h{{ db_host }} -e "SELECT 1;"
      register: mysql_test
      changed_when: false
      no_log: true
      tags: mysql
      when: false
    
    - name: 4.9 - Vérifier les bases de données
      command: mysql -u{{ db_username }} -p{{ db_password }} -h{{ db_host }} -e "SHOW DATABASES;"
      register: mysql_databases
      changed_when: false
      no_log: true
      tags: mysql
      when: false
    
    - name: 4.10 - Afficher les bases de données
      debug:
        msg: "{{ mysql_databases.stdout_lines }}"
      tags: mysql
      when: false
    
    - name: 4.11 - Message de succès ÉTAPE 4
      debug:
        msg:
          - "=========================================="
          - " ÉTAPE 4 COMPLÉTÉE AVEC SUCCÈS !"
          - "=========================================="
          - "MySQL 8.0 installé et configuré"
          - "Base de données : magento"
          - "Utilisateur : magento_admin"
          - "MySQL optimisé pour Magento"
          - "Test connexion : OK "
          - "=========================================="
      tags: mysql
